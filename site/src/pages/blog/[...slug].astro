---
import BaseLayout from '../../layouts/BaseLayout.astro'
import { Markdown } from 'astro/components';

import { getSanityContent } from 'utils:helpers';
import allPosts from 'sanityQL:allPosts';
import PageTopper from 'component:PageTopper';
import CanonicalNotice from 'component:vue:CanonicalNotice';
import TableOfContents from 'component:vue:TableOfContents';


export async function getStaticPaths({rss}) {
  const response = await getSanityContent({query: allPosts});
  const allBlogPosts = response.allPost;

  rss({
    title: 'Building Better Builders > Bald Bearded Builder',
    description: 'Home of the Bald. Bearded. Builder. community. Working to build better builders.',
    customData: `<language>en-us</language>`,
    items: allBlogPosts.map(item => ({
      title: item.title,
      description: item.excerpt,
      link: `/blog/${item.slug.current}`,
      pubDate: item.publishedAt,
    })),
  });
  return allBlogPosts.map(post => ({params: { slug: post.slug.current }, props: {post}}));
}

const { post } = Astro.props;
const canonicalUrl = post.canonicalUrl || Astro.request.canonicalURL.href;
---

<BaseLayout title={post.title} description={post.excerpt} permalink={Astro.request.canonicalURL} canonicalUrl={canonicalUrl}>
    <article class="page">
        <header>
        <img src={post.coverImage.asset.url} alt={post.title}/>
        </header>
        <main>
            <aside>
                <!-- <TableOfContents
                toc={toc}
                levels={levels}
                client:load
                /> -->
            </aside>
            <section class="content">
                <PageTopper title={post.title} />
                <CanonicalNotice canonicalUrl={post.canonicalUrl} />
                <Markdown content={post.body}></Markdown>
            </section>
        </main>
    </article>
</BaseLayout>